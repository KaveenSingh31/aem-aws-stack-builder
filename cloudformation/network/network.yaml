---
AWSTemplateFormatVersion: "2010-09-09"

Description:
  Create Subnets, Internet Gateway, and Route Tables for AEM Stack

Parameters:
  VpcIdParameter:
    Type: AWS::EC2::VPC::Id
    Default: vpc-2fc3014b
    Description: The VPC to create the AEM Network in.

  AvailabilityZoneAParameter:
    Type: AWS::EC2::AvailabilityZone::Name
    Default: eu-west-1a
    Description: Availability Zone A

  AvailabilityZoneBParameter:
    Type: AWS::EC2::AvailabilityZone::Name
    Default: eu-west-1b
    Description: Availability Zone B

  AvailabilityZoneCParameter:
    Type: AWS::EC2::AvailabilityZone::Name
    Default: eu-west-1c
    Description: Availability Zone C

  Ec2InternetGatewayTagNameParameter:
    Type: String
    Default: AEM VPC Internet Gateway
    Description: AEM VPC Internet Gateway Name

  PublishDispatcherELBSubnetACidrBlockParameter:
    Type: String
    Default: 10.1.1.0/25
    Description: AEM Publish Dispatcher ELB Subnet A Cidr Block

  PublishDispatcherELBSubnetATagNameParameter:
    Type: String
    Default: AEM Publish Dispatcher ELB Subnet A
    Description: AEM Publish Dispatcher ELB Subnet A Name

  PublishDispatcherELBSubnetBCidrBlockParameter:
    Type: String
    Default: 10.1.1.128/25
    Description: AEM Publish Dispatcher ELB Subnet B Cidr Block

  PublishDispatcherELBSubnetBTagNameParameter:
    Type: String
    Default: AEM Publish Dispatcher ELB Subnet B
    Description: AEM Publish Dispatcher ELB Subnet B Name

  PublishDispatcherELBSubnetCCidrBlockParameter:
    Type: String
    Default: 10.1.2.0/25
    Description: AEM Publish Dispatcher ELB Subnet C Cidr Block

  PublishDispatcherELBSubnetCTagNameParameter:
    Type: String
    Default: AEM Publish Dispatcher ELB Subnet C
    Description: AEM Publish Dispatcher ELB Subnet C Name

  PublishDispatcherSubnetACidrBlockParameter:
    Type: String
    Default: 10.1.2.128/25
    Description: AEM Publish Dispatcher Subnet A Cidr Block

  PublishDispatcherSubnetATagNameParameter:
    Type: String
    Default: AEM Publish Dispatcher Subnet A
    Description: AEM Publish Dispatcher Subnet A Name

  PublishDispatcherSubnetBCidrBlockParameter:
    Type: String
    Default: 10.1.3.0/25
    Description: AEM Publish Dispatcher Subnet B Cidr Block

  PublishDispatcherSubnetBTagNameParameter:
    Type: String
    Default: AEM Publish Dispatcher Subnet B
    Description: AEM Publish Dispatcher Subnet B Name

  PublishDispatcherSubnetCCidrBlockParameter:
    Type: String
    Default: 10.1.3.128/25
    Description: AEM Publish Dispatcher Subnet C Cidr Block

  PublishDispatcherSubnetCTagNameParameter:
    Type: String
    Default: AEM Publish Dispatcher Subnet C
    Description: AEM Publish Dispatcher Subnet C Name

  PublishSubnetACidrBlockParameter:
    Type: String
    Default: 10.1.4.0/25
    Description: AEM Publish Subnet A Cidr Block

  PublishSubnetATagNameParameter:
    Type: String
    Default: AEM Publish Subnet A
    Description: AEM Publish Subnet A Name

  PublishSubnetBCidrBlockParameter:
    Type: String
    Default: 10.1.4.128/25
    Description: AEM Publish Subnet B Cidr Block

  PublishSubnetBTagNameParameter:
    Type: String
    Default: AEM Publish Subnet B
    Description: AEM Publish Subnet B Name

  PublishSubnetCCidrBlockParameter:
    Type: String
    Default: 10.1.5.0/25
    Description: AEM Publish Subnet C Cidr Block

  PublishSubnetCTagNameParameter:
    Type: String
    Default: AEM Publish Subnet C
    Description: AEM Publish Subnet C Name

  AuthorSubnetACidrBlockParameter:
    Type: String
    Default: 10.1.5.128/25
    Description: AEM Author Subnet A Cidr Block

  AuthorSubnetATagNameParameter:
    Type: String
    Default: AEM Author Subnet A
    Description: AEM Author Subnet A Name

  AuthorSubnetBCidrBlockParameter:
    Type: String
    Default: 10.1.6.0/25
    Description: AEM Author Subnet B Cidr Block

  AuthorSubnetBTagNameParameter:
    Type: String
    Default: AEM Auhtor Subnet B
    Description: AEM Author Subnet B Name

  AuthorSubnetCCidrBlockParameter:
    Type: String
    Default: 10.1.6.128/25
    Description: AEM Author Subnet C Cidr Block

  AuthorSubnetCTagNameParameter:
    Type: String
    Default: AEM Auhtor Subnet C
    Description: AEM Author Subnet C Name

  AuthorDispatcherSubnetACidrBlockParameter:
    Type: String
    Default: 10.1.7.0/25
    Description: AEM Author Dispatcher Subnet A Cidr Block

  AuthorDispatcherSubnetATagNameParameter:
    Type: String
    Default: AEM Author Dispatcher Subnet A
    Description: AEM Author Dispatcher Subnet A Name

  AuthorDispatcherSubnetBCidrBlockParameter:
    Type: String
    Default: 10.1.7.128/25
    Description: AEM Author Dispatcher Subnet B Cidr Block

  AuthorDispatcherSubnetBTagNameParameter:
    Type: String
    Default: AEM Author Dispatcher Subnet B
    Description: AEM Author Dispatcher Subnet B Name

  AuthorDispatcherSubnetCCidrBlockParameter:
    Type: String
    Default: 10.1.8.0/25
    Description: AEM Author Dispatcher Subnet C Cidr Block

  AuthorDispatcherSubnetCTagNameParameter:
    Type: String
    Default: AEM Author Dispatcher Subnet C
    Description: AEM Author Dispatcher Subnet C Name


  ToolSubnetACidrBlockParameter:
    Type: String
    Default: 10.1.8.128/25
    Description: Tool Subnet A Cidr Block

  ToolSubnetATagNameParameter:
    Type: String
    Default: AEM Tool Subnet A
    Description: AEM Tool Subnet A Name

  ToolSubnetBCidrBlockParameter:
    Type: String
    Default: 10.1.9.0/25
    Description: Tool Subnet B Cidr Block

  ToolSubnetBTagNameParameter:
    Type: String
    Default: AEM Tool Subnet B
    Description: AEM Tool Subnet B Name

  ToolSubnetCCidrBlockParameter:
    Type: String
    Default: 10.1.9.128/25
    Description: Tool Subnet C Cidr Block

  ToolSubnetCTagNameParameter:
    Type: String
    Default: AEM Tool Subnet C
    Description: AEM Tool Subnet C Name

  PublicRouteTableTagNameParameter:
    Type: String
    Default: AEM VPC Public Route Table
    Description: AEM VPC Public Route Table Name

  PrivateRouteTableTagNameParameter:
    Type: String
    Default: AEM VPC Private Route Table
    Description: AEM VPC Private Route Table Name


Resources:
  Ec2InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value:
            Ref: Ec2InternetGatewayTagNameParameter

# TODO: set/change the Main Route Table?

  Ec2VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId:
        Ref: Ec2InternetGateway
      VpcId:
        Ref: VpcIdParameter


  PublishDispatcherELBSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneAParameter
      CidrBlock:
        Ref: PublishDispatcherELBSubnetACidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: PublishDispatcherELBSubnetATagNameParameter
      VpcId:
        Ref: VpcIdParameter

  PublishDispatcherELBSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneBParameter
      CidrBlock:
        Ref: PublishDispatcherELBSubnetBCidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: PublishDispatcherELBSubnetBTagNameParameter
      VpcId:
        Ref: VpcIdParameter

  PublishDispatcherELBSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneCParameter
      CidrBlock:
        Ref: PublishDispatcherELBSubnetCCidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: PublishDispatcherELBSubnetCTagNameParameter
      VpcId:
        Ref: VpcIdParameter

  PublishDispatcherSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneAParameter
      CidrBlock:
        Ref: PublishDispatcherSubnetACidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: PublishDispatcherSubnetATagNameParameter
      VpcId:
        Ref: VpcIdParameter

  PublishDispatcherSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneBParameter
      CidrBlock:
        Ref: PublishDispatcherSubnetBCidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: PublishDispatcherSubnetBTagNameParameter
      VpcId:
        Ref: VpcIdParameter


  PublishDispatcherSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneCParameter
      CidrBlock:
        Ref: PublishDispatcherSubnetCCidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: PublishDispatcherSubnetCTagNameParameter
      VpcId:
        Ref: VpcIdParameter

  PublishSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneAParameter
      CidrBlock:
        Ref: PublishSubnetACidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: PublishSubnetATagNameParameter
      VpcId:
        Ref: VpcIdParameter

  PublishSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneBParameter
      CidrBlock:
        Ref: PublishSubnetBCidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: PublishSubnetBTagNameParameter
      VpcId:
        Ref: VpcIdParameter

  PublishSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneCParameter
      CidrBlock:
        Ref: PublishSubnetCCidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: PublishSubnetCTagNameParameter
      VpcId:
        Ref: VpcIdParameter

  AuthorSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneAParameter
      CidrBlock:
        Ref: AuthorSubnetACidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: AuthorSubnetATagNameParameter
      VpcId:
        Ref: VpcIdParameter

  AuthorSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneBParameter
      CidrBlock:
        Ref: AuthorSubnetBCidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: AuthorSubnetBTagNameParameter
      VpcId:
        Ref: VpcIdParameter

  AuthorSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneCParameter
      CidrBlock:
        Ref: AuthorSubnetCCidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: AuthorSubnetCTagNameParameter
      VpcId:
        Ref: VpcIdParameter


  AuthorDispatcherSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneAParameter
      CidrBlock:
        Ref: AuthorDispatcherSubnetACidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: AuthorDispatcherSubnetATagNameParameter
      VpcId:
        Ref: VpcIdParameter

  AuthorDispatcherSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneBParameter
      CidrBlock:
        Ref: AuthorDispatcherSubnetBCidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: AuthorDispatcherSubnetBTagNameParameter
      VpcId:
        Ref: VpcIdParameter


  AuthorDispatcherSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneCParameter
      CidrBlock:
        Ref: AuthorDispatcherSubnetCCidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: AuthorDispatcherSubnetCTagNameParameter
      VpcId:
        Ref: VpcIdParameter


  ToolSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneAParameter
      CidrBlock:
        Ref: ToolSubnetACidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: ToolSubnetATagNameParameter
      VpcId:
        Ref: VpcIdParameter

  ToolSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneBParameter
      CidrBlock:
        Ref: ToolSubnetBCidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: ToolSubnetBTagNameParameter
      VpcId:
        Ref: VpcIdParameter


  ToolSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: AvailabilityZoneCParameter
      CidrBlock:
        Ref: ToolSubnetCCidrBlockParameter
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value:
            Ref: ToolSubnetCTagNameParameter
      VpcId:
        Ref: VpcIdParameter

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: VpcIdParameter
      Tags:
        - Key: Name
          Value:
            Ref: PublicRouteTableTagNameParameter
# TODO: the RouteTable Name Tag is not being set?

  PublicInternetGatewayRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: Ec2InternetGateway
      RouteTableId:
        Ref: PublicRouteTable
    DependsOn: Ec2VPCGatewayAttachment

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: VpcIdParameter
      Tags:
        - Key: Name
          Value:
            Ref: PrivateRouteTableTagNameParameter
# TODO: the RouteTable Name Tag is not being set?

  PublishDispatcherELBSubnetAPublicRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      SubnetId:
        Ref: PublishDispatcherELBSubnetA

  PublishDispatcherELBSubnetBPublicRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      SubnetId:
        Ref: PublishDispatcherELBSubnetB


  PublishDispatcherELBSubnetCPublicRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      SubnetId:
        Ref: PublishDispatcherELBSubnetC

  PublishDispatcherSubnetAPrivateRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: PublishDispatcherSubnetA

  PublishDispatcherSubnetBPrivateRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: PublishDispatcherSubnetB

  PublishDispatcherSubnetCPrivateRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: PublishDispatcherSubnetC

  PublishSubnetAPrivatecRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: PublishSubnetA

  PublishSubnetBPrivateRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: PublishSubnetB

  PublishSubnetCPrivateRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: PublishSubnetC

  AuthorSubnetAPrivatecRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: AuthorSubnetA

  AuthorSubnetBPrivateRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: AuthorSubnetB

  AuthorSubnetCPrivateRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: AuthorSubnetC

  AuthorDispatcherSubnetAPrivatecRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: AuthorDispatcherSubnetA

  AuthorDispatcherSubnetBPrivateRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: AuthorDispatcherSubnetB

  AuthorDispatcherSubnetCPrivateRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: AuthorDispatcherSubnetC

  ToolSubnetAPrivatecRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: ToolSubnetA

  ToolSubnetBPrivateRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: ToolSubnetB

  ToolSubnetCPrivateRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: ToolSubnetC


Outputs:

  PublishDispatcherELBSubnetA:
    Value:
      Ref: PublishDispatcherELBSubnetA
    Description: The Publish Dispatcher ELB Subnet in Availability Zone A

  PublishDispatcherELBSubnetB:
    Value:
      Ref: PublishDispatcherELBSubnetB
    Description: The Publish Dispatcher ELB Subnet in Availability Zone B

  PublishDispatcherELBSubnetC:
    Value:
      Ref: PublishDispatcherELBSubnetC
    Description: The Publish Dispatcher ELB Subnet in Availability Zone C

  PublishDispatcherSubnetA:
    Value:
      Ref: PublishDispatcherSubnetA
    Description: The Publish Dispatcher Subnet in Availability Zone A

  PublishDispatcherSubnetB:
    Value:
      Ref: PublishDispatcherSubnetB
    Description: The Publish Dispatcher Subnet in Availability Zone B

  PublishDispatcherSubnetC:
    Value:
      Ref: PublishDispatcherSubnetC
    Description: The Publish Dispatcher Subnet in Availability Zone C

  PublishSubnetA:
    Value:
      Ref: PublishSubnetA
    Description: The Publish Subnet in Availability Zone A

  PublishSubnetB:
    Value:
      Ref: PublishSubnetB
    Description: The Publish Subnet in Availability Zone B

  PublishSubnetC:
    Value:
      Ref: PublishSubnetC
    Description: The Publish Subnet in Availability Zone C

  AuthorSubnetA:
    Value:
      Ref: AuthorSubnetA
    Description: The Author Subnet in Availability Zone A

  AuthorSubnetB:
    Value:
      Ref: AuthorSubnetB
    Description: The Author Subnet in Availability Zone B

  AuthorSubnetC:
    Value:
      Ref: AuthorSubnetC
    Description: The Author Subnet in Availability Zone C


  AuthorDispatcherSubnetA:
    Value:
      Ref: AuthorDispatcherSubnetA
    Description: The Author Dispatcher Subnet in Availability Zone A

  AuthorDispatcherSubnetB:
    Value:
      Ref: AuthorDispatcherSubnetB
    Description: The Author Dispatcher Subnet in Availability Zone B

  AuthorDispatcherSubnetC:
    Value:
      Ref: AuthorDispatcherSubnetC
    Description: The Author Dispatcher Subnet in Availability Zone C

  ToolSubnetA:
    Value:
      Ref: ToolSubnetA
    Description: The Tool Subnet in Availability Zone A

  ToolSubnetB:
    Value:
      Ref: ToolSubnetB
    Description: The Tool Subnet in Availability Zone B

  ToolSubnetC:
    Value:
      Ref: ToolSubnetC
    Description: The Tool Subnet in Availability Zone C

  PublicRouteTable:
    Value:
      Ref: PublicRouteTable
    Description: The Public Route Table for AEM Stack VPC
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PublicRouteTable

  PrivateRouteTable:
    Value:
      Ref: PrivateRouteTable
    Description: The Private Route Table for AEM Stack VPC
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PrivateRouteTable
